<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="Highcharts-2/js/highcharts.js" type="text/javascript"></script>
<script type="text/javascript" src="Highcharts-2/js/themes/dark-skies.js"></script>

<script type="text/javascript" charset="utf-8">

	//prepare data for graph; add zeros for months without data, convert data structure to array taken by Highcharts
	function getAllMonths(startYear,endYear, countsByYearAndMonth) {
		var allMonths = [];
		
		for (var i = startYear; i<=endYear; i++){
			var arrayOfCounts = [];
			for (var j = 1; j<=12; j++){
				var monthAsString = (j.toString().length < 2) ? '0' + j.toString() : j.toString();
				arrayOfCounts.push(countsByYearAndMonth[i][monthAsString] ? countsByYearAndMonth[i][monthAsString] : 0)		
			}
			var yearSummary = {name:i.toString(), data: arrayOfCounts}
			allMonths.push(yearSummary)
		}		
		return allMonths;		
	}


	function projectStartByMonth(data) {
	var selectedProjects = data.projects;
	var endYear = null;
	var startYear = null;
	
	var countsByYearAndMonth = new Object();
      	for (var i=0; i < selectedProjects.length; i++) {
      		var project = selectedProjects[i];
      		if(project.started){
      		
      		var monthStarted = project.started.slice(5,7);
      		var yearStarted = project.started.slice(0,4);
      		
      		if (yearStarted > endYear || endYear == null){
      			endYear = yearStarted
      		}
      		if (yearStarted < startYear || startYear == null){
      			startYear = yearStarted
      		}
      		if (countsByYearAndMonth[yearStarted]) {
      			if(countsByYearAndMonth[yearStarted][monthStarted]){
      				countsByYearAndMonth[yearStarted][monthStarted]++;
      			}
      			else {
      				countsByYearAndMonth[yearStarted][monthStarted] = 1;
      			}
      		}
      		else {
      			var months = new Object();
      			months[monthStarted]=1;
      			countsByYearAndMonth[yearStarted] = months;
      		}  
      		}  		
      	}
      	
      	
    var allMonths = getAllMonths(startYear, endYear, countsByYearAndMonth)
      	
      	var chart;
    $(document).ready(function() {
        chart = new Highcharts.Chart({
            chart: {
                renderTo: 'container',
                type: 'column'
            },
            title: {
                text: 'Projects Started by Month'
            },
            xAxis: {
                categories: [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ]
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Projects'
                }
            },
            legend: {
                layout: 'vertical',
                backgroundColor: '#FFFFFF',
                align: 'left',
                verticalAlign: 'top',
                x: 150,
                y: 30,
                floating: true,
                shadow: true
            },
            tooltip: {
                formatter: function() {
                    return ''+
                        this.x + ' ' + this.series.name + ': '+ this.y + ((this.y==1) ? ' project' : ' projects');
                }
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
                series: allMonths
        });
    });
	
	}
   
  Ravalytics = function() {   
    var projectData = null; 
    return {
    projectReceived: function(data) {
        projectData = data;
      },
    
      calculate: function() {
      	projectStartByMonth(projectData);
      	
      }
     }
  }();
</script>
<script src="http://api.ravelry.com/projects/blacktabi/progress.json?callback=Ravalytics.projectReceived&key=2db7bf6bf741e85881eb4b22e97f556029ee5e25&status=in-progress+hibernating+finished+frogged&notes=true"></script>
</head>
<body>			 
<div id="container" style="width: 100%; height: 400px"></div>
<script> Ravalytics.calculate(); </script>
</body>